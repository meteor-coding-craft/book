# 29.4 서버의 리액티비티

미티어 서버에서 리액티비티의 핵심은 몽고DB 데이터 변화에 대한 감지다. 몽고DB\(마스터 또는 프라이머리\)는 데이터에 변화가 있을 때마다 오퍼레이션 로그를 남기고 복제 서버\(슬레이브 또는 세컨더리\)들이 로그를 읽어 스스로 반영한다. 이를 간단하게 도식화하면 다음과 같다.

![&#xADF8;&#xB9BC; 29-13 &#xBABD;&#xACE0;DB&#xC758; &#xBCF5;&#xC81C;\(&#xB808;&#xD50C;&#xB9AC;&#xCE74; &#xC138;&#xD2B8;\) &#xC6D0;&#xB9AC;](../.gitbook/assets/image%20%2819%29.png)

insert나 update 또는 remove에 의한 데이터 변경이 있을 때마다 몽고DB 프라이머리는 자신의 local 데이터베이스의 oplog.rs라는 컬렉션에 모든 로그를 기록한다. 만약 한 건의 update 요청에 의해 여러 건에 영향을 미쳤다면 친절하게도 모든 영향 받은 데이터를 로그로 남긴다. 이를 통해 세컨더리 몽고DB들은 서버와 똑같은 데이터를 가질 수 있게 된다.

이런 몽고DB의 복제 원리를 미티어에서 잘 이용하고 있다. 그림으로 그려 보면 다음과 같다.

![&#xADF8;&#xB9BC; 29-14 &#xBBF8;&#xD2F0;&#xC5B4;&#xC758; oplog &#xC2A4;&#xCE90;&#xB2DD;](../.gitbook/assets/image%20%2826%29.png)

미티어 서버는 몽고DB의 슬레이브와 같이 oplog를 스캐닝하고 있다가 변화가 감지되면 구독 요청이 들어온, 현재 연결된 모든 웹 브라우저에 변화된 데이터를 보내준다. 따라서 웹 브라우저에서도 미니몽고에 반영할 수 있게 되는 것이다. 이제 서버의 리액티비티와 브라우저에서의 리액티비티를 하나로 연결하여 데이터 흐름을 보면 다음 그림과 같다.

![&#xADF8;&#xB9BC; 29-15 &#xBBF8;&#xD2F0;&#xC5B4;&#xC758; &#xB9AC;&#xC561;&#xD2F0;&#xBE44;&#xD2F0;](../.gitbook/assets/image%20%2816%29.png)

1. 몽고DB에서 insert, update, remove 등으로 인해 변화가 일어난다.
2. 몽고DB는 oplog에 변화에 대한 모든 로그를 남긴다.
3. 미티어 서버는 oplog의 변화를 감지한다.
4. 변경된 데이터를 발행/구독으로 연결된 클라이언트로 전송한다.
5. 미티어 서버에서 구독하여 변경된 정보를 미니몽고에 반영한다.
6. 템플릿 헬퍼는 미니몽고 변화를 감지하고 변경된 데이터를 DOM에 제공한다.
7. 변경된 데이터로 해당 DOM을 업데이트한다.

이렇게 해서 몽고DB에서 변경된 데이터는 클라이언트까지 실시간으로 반영될 수 있다. 이 구간은 모두 리액티비티의 원리로 설명할 수 있다.

